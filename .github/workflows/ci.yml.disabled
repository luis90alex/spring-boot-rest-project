name: CI
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
jobs:
  build-test:
    name: Build & unit tests
    runs-on: ubuntu-22.04
    steps:
      - name: Repository checkout # Checkouts our repo to the runner
        uses: actions/checkout@v6
      - name: Set up Java 17 # Installs java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: Show java & Maven
        run: |
          java -version
          ./mvnw -v
      - name: Run unit tests
        run: |
          ./mvnw -B -V test
      - name: Upload surefire reports # artifacts are saved and downloadable
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 5
  integration-test:
    name: Integration tests (Testcontainers / Failsafe)
    runs-on: ubuntu-22.04
    needs: build-test # The previous job 'build-test' is needed
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - name: Repository checkout # Checkouts our repo to the runner
        uses: actions/checkout@v6
      - name: Set up Java 17 # Installs java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      - name: Debug JWT_SECRET length
        run: |
          echo "JWT_SECRET length: ${#JWT_SECRET}"
      # verify executes integration tests (failsafe) and unit tests are skipped
      - name: Run integration tests (verify)
        run: |
          ./mvnw -B -V -DskipUnitTests=true verify
        timeout-minutes: 40
      - name: Upload failsafe reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failsafe-reports
          path: target/failsafe-reports/
          retention-days: 5
  docker-build-push:
    name: Build, Scan and Publish image to GHCR
    runs-on: ubuntu-22.04
    needs: integration-test
    # Permissions of the GitHub token
    # Contents = read allows cloning , reading commits , file access...
    # Package = write allows publishing and modifying packages
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout # Possibly this is not needed, it could be used git context
        uses: actions/checkout@v6
      - name: Set up QEMU # Used to allow emulating different architectures
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx # Used to install and configure Buildx (multi-arch)
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Determine image tag
        id: meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          # Same image with two tags : latest and the computed tag (used to tracking and control)
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.tag }}
      - name: Scan image with Trivy (optional) # Vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.tag }}
          format: 'table'
          # fail-on-high: 'true'   # Optionally fail if a high vulnerability is found
  # TO DO  Add smoke tests